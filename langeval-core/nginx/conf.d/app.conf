server {
    listen 80 default_server;
    server_name api.langeval.space _ localhost;
    server_tokens off;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Root health check
    location = / {
        return 200 '{"status": "ok", "message": "Langeval API Gateway", "services": {"identity": "/identity/", "resource": "/resource/", "orchestrator": "/orchestrator/", "gen_ai": "/gen-ai/", "simulation": "/simulation/", "evaluation": "/evaluation/"}}';
        add_header Content-Type application/json;
    }

    # --- Docker DNS Resolver (Dynamic Re-resolution) ---
    resolver 127.0.0.11 valid=10s;
    set $identity_service identity-service;
    set $resource_service resource-service;
    set $orchestrator orchestrator;
    set $gen_ai_service gen-ai-service;
    set $billing_service billing-service;
    set $simulation_worker simulation-worker;
    set $evaluation_worker evaluation-worker;

    # --- API v1 Unified Routing (Matches Local Dev) ---
    location /api/v1/auth/ {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/workspaces {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/invites {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/resource/ {
        proxy_pass http://$resource_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/orchestrator/ {
        proxy_pass http://$orchestrator:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/gen-ai/ {
        proxy_pass http://$gen_ai_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/billing/ {
        proxy_pass http://$billing_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Legacy / Service Direct Paths ---
    location /identity/ {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /resource/ {
        proxy_pass http://$resource_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    # Orchestrator also uses /orchestrator prefix internally for some routes
    location /orchestrator/ {
        proxy_pass http://$orchestrator:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /gen-ai/ {
        proxy_pass http://$gen_ai_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Workers (Exposed for Swagger UI) ---
    location /simulation/ {
        proxy_pass http://$simulation_worker:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /evaluation/ {
        proxy_pass http://$evaluation_worker:8000;
        include /etc/nginx/conf.d/proxy_params;
    }
}

server {
    listen 443 ssl;
    server_name api.langeval.space;
    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/api.langeval.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.langeval.space/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location = / {
        return 200 '{"status": "ok", "message": "Langeval API Gateway", "services": {"identity": "/identity/", "resource": "/resource/", "orchestrator": "/orchestrator/", "gen_ai": "/gen-ai/", "simulation": "/simulation/", "evaluation": "/evaluation/"}}';
        add_header Content-Type application/json;
    }

    # --- Docker DNS Resolver (Dynamic Re-resolution) ---
    resolver 127.0.0.11 valid=10s;
    set $identity_service identity-service;
    set $resource_service resource-service;
    set $orchestrator orchestrator;
    set $gen_ai_service gen-ai-service;
    set $billing_service billing-service;
    set $simulation_worker simulation-worker;
    set $evaluation_worker evaluation-worker;

    # --- API v1 Unified Routing ---
    location /api/v1/auth/ {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/workspaces {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/invites {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/resource/ {
        proxy_pass http://$resource_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/orchestrator/ {
        proxy_pass http://$orchestrator:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/gen-ai/ {
        proxy_pass http://$gen_ai_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /api/v1/billing/ {
        proxy_pass http://$billing_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Legacy Paths ---
    location /identity/ {
        proxy_pass http://$identity_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /resource/ {
        proxy_pass http://$resource_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /orchestrator/ {
        proxy_pass http://$orchestrator:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /gen-ai/ {
        proxy_pass http://$gen_ai_service:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    # --- Workers ---
    location /simulation/ {
        proxy_pass http://$simulation_worker:8000;
        include /etc/nginx/conf.d/proxy_params;
    }

    location /evaluation/ {
        proxy_pass http://$evaluation_worker:8000;
        include /etc/nginx/conf.d/proxy_params;
    }
}

# --- Langfuse Trace Domain ---
server {
    listen 80;
    server_name trace.langeval.space;
    server_tokens off;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://langfuse-server:3000;
        include /etc/nginx/conf.d/proxy_params;
    }
}

# Tạm thời comment block HTTPS này lại để Nginx có thể khởi động khi chưa có Cert.
# Sau khi bạn chạy Certbot thành công, hãy uncomment block này.
# server {
#     listen 443 ssl;
#     server_name trace.langeval.space;
#     server_tokens off;
# 
#     ssl_certificate /etc/letsencrypt/live/trace.langeval.space/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/trace.langeval.space/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
# 
#     location / {
#         proxy_pass http://langfuse-server:3000;
#         include /etc/nginx/conf.d/proxy_params;
#     }
# }
